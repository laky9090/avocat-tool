<!DOCTYPE html>
<html lang="fr" data-theme="light">
<head>
    <meta charset="UTF-8">
    <title>Ma√Ætre Candice ROVERA - Gestion Financi√®re</title>
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="css/finance.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>
</head>
<body>
    <button id="themeToggle" class="theme-toggle">
        <span id="themeIcon">üåû</span>
        <span id="themeText">Mode sombre</span>
    </button>

    <header>
        <h1>Gestion Financi√®re</h1>
        <div class="header-actions">
            <button id="returnBtn" onclick="window.location.href='index.html'">Retour</button>
        </div>
    </header>

    <div class="finance-dashboard">
        <!-- Coordonn√©es du cabinet -->
        <div class="cabinet-info">
            <div class="lawyer-details">
                <h3>Ma√Ætre Candice ROVERA</h3>
                <p>Avocat au Barreau de Paris</p>
                <p>SIRET : 98302483700020</p>
                <p>TVA Intracommunautaire : FR13983024837</p>
            </div>
        </div>

        <!-- R√©sum√© financier -->
        <div class="finance-summary">
            <div class="stat-card">
                <h3>Chiffre d'affaires HT de l'ann√©e en cours</h3>
                <div id="totalHT" class="stat-value">0 ‚Ç¨</div>
            </div>
            <div class="stat-card">
                <h3>TVA (20%)</h3>
                <div id="totalTVA" class="stat-value">0 ‚Ç¨</div>
            </div>
            <div class="stat-card">
                <h3>Total TTC</h3>
                <div id="totalTTC" class="stat-value">0 ‚Ç¨</div>
            </div>
        </div>

        <!-- Graphiques -->
        <div class="charts-container" style="display: flex; flex-wrap: wrap; gap: 20px;">
            <!-- Premier graphique (√† gauche) -->
            <div class="chart-section" style="flex: 1; min-width: 45%;">
                <h3>Evolution du CA mensuel</h3>
                <div class="chart-container" style="position: relative; height: 350px; width: 100%;">
                    <canvas id="revenueChart"></canvas>
                </div>
            </div>
            
            <!-- Deuxi√®me graphique (√† droite) -->
            <div class="chart-section" style="flex: 1; min-width: 45%;">
                <h3>R√©partition par type de dossier</h3>
                <div class="chart-container" style="position: relative; height: 350px; width: 100%;">
                    <canvas id="dossiersChart"></canvas>
                </div>
            </div>
        </div>

        <!-- Espace de s√©paration avant la section des factures -->
        <div style="margin-top: 40px;"></div>

        <!-- Gestion des factures -->
        <div class="invoices-section">
            <h2>Gestion des factures</h2>
            <button id="createInvoiceBtn" class="primary-button">Cr√©er une nouvelle facture</button>
            
            <!-- Liste des factures -->
            <div class="invoices-list">
                <table id="invoicesTable">
                    <thead>
                        <tr>
                            <th>N¬∞ Facture</th>
                            <th>Client</th>
                            <th>Date</th>
                            <th>Description</th>
                            <th>Montant HT</th>
                            <th>Total TTC</th>
                            <th>Statut</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>

        <!-- Template de facture -->
        <div id="invoiceTemplate" style="display: none;">
            <div class="invoice-header">
                <div class="lawyer-info">
                    <h2>Ma√Ætre Candice ROVERA</h2>
                    <p>Avocat au Barreau de Paris</p>
                    <p>[Adresse du cabinet]</p>
                    <p>T√©l: [Num√©ro de t√©l√©phone]</p>
                    <p>Email: [Email professionnel]</p>
                    <p>SIRET : 98302483700020</p>
                    <p>TVA Intracommunautaire : FR13983024837</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal pour cr√©er/modifier une facture -->
    <div id="invoiceModal" class="modal">
        <div class="modal-content">
            <button class="close-modal">√ó</button>
            <h2>Cr√©ation de facture</h2>
            <form id="invoiceForm">
                <!-- En-t√™te de facture -->
                <div class="form-group">
                    <label>Client :</label>
                    <select id="clientSelect" required></select>
                </div>

                <!-- Tableau des prestations -->
                <div class="form-group">
                    <table class="invoice-table">
                        <thead>
                            <tr>
                                <th>Description de la prestation</th>
                                <th>Montant HT</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="prestationsContainer">
                            <tr class="prestation-item">
                                <td><input type="text" class="prestation-desc" placeholder="Description" required></td>
                                <td><input type="number" class="prestation-amount" placeholder="0.00" step="0.01" required onchange="updateTotals()"></td>
                                <td><button type="button" class="remove-row" onclick="removeRow(this)">√ó</button></td>
                            </tr>
                        </tbody>
                        <tfoot>
                            <tr>
                                <td colspan="3">
                                    <button type="button" class="add-row">+ Ajouter une ligne</button>
                                </td>
                            </tr>
                            <tr class="totals">
                                <td>Total HT</td>
                                <td id="invoiceTotalHT">0.00 ‚Ç¨</td>
                                <td></td>
                            </tr>
                            <tr class="totals">
                                <td>TVA (20%)</td>
                                <td id="invoiceTVA">0.00 ‚Ç¨</td>
                                <td></td>
                            </tr>
                            <tr class="totals">
                                <td>Total TTC</td>
                                <td id="invoiceTotalTTC">0.00 ‚Ç¨</td>
                                <td></td>
                            </tr>
                        </tfoot>
                    </table>
                </div>

                <div class="button-group">
                    <button type="submit" class="primary-button">G√©n√©rer et envoyer la facture</button>
                    <button type="button" class="secondary-button" onclick="closeModal()">Annuler</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal pour l'envoi d'email -->
    <div id="emailModal" class="modal">
        <div class="modal-content">
            <button class="close-modal" onclick="closeEmailModal()">√ó</button>
            <h2>Envoyer la facture par email</h2>
            <form id="emailForm">
                <div class="form-group">
                    <label for="emailFrom">De :</label>
                    <input type="email" id="emailFrom" value="candicerovera@gmail.com" readonly>
                </div>
                <div class="form-group">
                    <label for="emailTo">√Ä :</label>
                    <input type="email" id="emailTo" required>
                </div>
                <div class="form-group">
                    <label for="emailCc">Cc :</label>
                    <input type="email" id="emailCc">
                </div>
                <div class="form-group">
                    <label for="emailSubject">Objet :</label>
                    <input type="text" id="emailSubject" required>
                </div>
                <div class="form-group">
                    <label for="emailBody">Message :</label>
                    <textarea id="emailBody" rows="12" required></textarea>
                </div>
                <div class="form-group files-list">
                    <label>Pi√®ces jointes :</label>
                    <ul id="attachmentsList"></ul>
                </div>
                <div class="button-group">
                    <button type="submit" class="primary-button">Envoyer</button>
                    <button type="button" class="secondary-button" onclick="closeEmailModal()">Annuler</button>
                </div>
            </form>
        </div>
    </div>

    <div style="margin-top: 20px;">
        <!-- Espace r√©serv√© pour des boutons futurs si besoin -->
    </div>

    <footer>
        Ma√Ætre Candice ROVERA - Avocat au Barreau de Paris
    </footer>

    <!-- Ajouter juste avant les autres scripts -->
    <script>
    // Pr√©parer le module remote
    try {
        window.require = require;
    } catch (e) {
        console.warn('Module require non disponible. Mode navigateur d√©tect√©.');
    }
    </script>

    <!-- Ordre de chargement correct -->
    <script src="js/utils.js"></script>
    <script src="js/path-manager.js"></script>  <!-- Nouveau fichier √† chargeur en premier -->
    <script src="js/window-manager.js"></script>
    <script src="js/modal-manager.js"></script>
    <script src="js/client-manager.js"></script>
    <script src="js/invoice-manager.js"></script>
    <script src="js/chart-manager.js"></script>
    <script src="js/finance-core.js"></script>
    <script>
    // Script de d√©marrage pour s'assurer que tout fonctionne
    document.addEventListener('DOMContentLoaded', function() {
        console.log('Page finance charg√©e - script de secours');
        
        // V√©rifier que les variables globales sont d√©finies
        window.clients = window.clients || [];
        window.invoices = window.invoices || [];
        
        // AJOUT CRUCIAL: Charger les factures au d√©marrage
        if (typeof loadInvoices === 'function') {
            console.log('Chargement automatique des factures...');
            loadInvoices();
        } else {
            console.error('Fonction loadInvoices non disponible!');
        }
        
        // S'assurer que les clients sont charg√©s
        if (typeof loadClients === 'function') {
            loadClients();
        }
        
        // AJOUT: Mettre √† jour l'interface apr√®s un court d√©lai
        setTimeout(function() {
            if (typeof updateInvoicesList === 'function') {
                console.log('Mise √† jour de la liste des factures apr√®s chargement');
                updateInvoicesList();
            }
            
            // AJOUT: Mettre √† jour √©galement les statistiques et graphiques
            if (typeof updateFinancialStats === 'function') {
                console.log('Mise √† jour des statistiques financi√®res');
                updateFinancialStats();
            }
            
            if (typeof updateCharts === 'function') {
                console.log('Mise √† jour des graphiques');
                updateCharts();
            }
        }, 800); // D√©lai l√©g√®rement plus long pour s'assurer que tout est charg√©
        
        // Attacher manuellement l'√©v√©nement au bouton
        const createBtn = document.getElementById('createInvoiceBtn');
        if (createBtn) {
            console.log('Bouton trouv√©, attachement de l\'√©v√©nement');
            createBtn.addEventListener('click', function() {
                console.log('Bouton cliqu√©');
                // Appeler la fonction de cr√©ation de facture
                if (typeof openInvoiceModal === 'function') {
                    openInvoiceModal();
                } else if (typeof recreateInvoiceModal === 'function') {
                    recreateInvoiceModal();
                    const modal = document.getElementById('invoiceModal');
                    if (modal) modal.style.display = 'flex';
                } else {
                    console.error('Aucune fonction de cr√©ation de facture trouv√©e');
                    alert('Fonction de cr√©ation de facture non disponible. Veuillez recharger la page.');
                }
            });
        } else {
            console.error('Bouton createInvoiceBtn non trouv√© dans le DOM');
        }
    });

    // Fonction de test pour le syst√®me de fichiers
    function testFileIO() {
        console.log('=== TEST DU SYST√àME DE FICHIERS ===');
        
        try {
            const fs = window.fs;
            const path = window.path;
            
            if (!fs || !path) {
                console.error('Modules fs ou path non disponibles');
                alert('Modules fs ou path non disponibles');
                return;
            }
            
            // Lister les fichiers √† la racine
            const rootPath = path.join(__dirname);
            console.log('Chemin racine:', rootPath);
            
            const files = fs.readdirSync(rootPath);
            console.log('Fichiers √† la racine:', files);
            
            // Tenter d'√©crire un fichier de test
            const testPath = path.join(rootPath, 'test-io.json');
            fs.writeFileSync(testPath, JSON.stringify({test: 'donn√©es de test', timestamp: new Date().toISOString()}));
            console.log('Fichier test-io.json cr√©√© avec succ√®s');
            
            // V√©rifier que le fichier invoices.json existe
            const invoicesPath = window.invoicesPath;
            if (fs.existsSync(invoicesPath)) {
                console.log('Le fichier invoices.json existe au chemin:', invoicesPath);
                // Lire son contenu
                const content = fs.readFileSync(invoicesPath, 'utf8');
                console.log('Taille du contenu:', content ? content.length : 0);
                
                if (content) {
                    try {
                        const data = JSON.parse(content);
                        console.log(`Le fichier contient ${data.length} factures`);
                        
                        // Essayer de sauvegarder le m√™me contenu
                        fs.writeFileSync(invoicesPath, JSON.stringify(data, null, 2));
                        console.log('R√©√©criture r√©ussie');
                        
                        alert(`Test r√©ussi! ${data.length} factures lues et sauvegard√©es.`);
                    } catch (e) {
                        console.error('Erreur lors du parsing JSON:', e);
                        alert('Erreur lors du parsing JSON: ' + e.message);
                    }
                } else {
                    console.log('Le fichier existe mais est vide');
                    fs.writeFileSync(invoicesPath, '[]');
                    alert('Le fichier invoices.json √©tait vide. Un tableau vide a √©t√© cr√©√©.');
                }
            } else {
                console.log('Le fichier invoices.json n\'existe pas, cr√©ation...');
                fs.writeFileSync(invoicesPath, '[]');
                alert('Le fichier invoices.json a √©t√© cr√©√© avec un tableau vide.');
            }
        } catch (error) {
            console.error('Erreur lors du test:', error);
            alert('Erreur: ' + error.message);
        }
    }

    function testSaveLoad() {
      try {
        // 1. Cr√©er facture test
        const testInvoice = {number: 'TEST-' + Date.now(), date: new Date().toISOString()};
        
        // 2. Sauvegarder
        window.invoices = [testInvoice];
        const saveOk = saveInvoicesToFile();
        
        // 3. Recharger
        window.invoices = [];
        loadInvoices();
        
        // 4. V√©rifier
        const found = window.invoices.find(i => i.number === testInvoice.number);
        
        alert(found ? 'Test r√©ussi! Sauvegarde fonctionnelle.' : '√âchec du test!');
        
        // Nettoyer
        window.invoices = window.invoices.filter(i => !i.number.startsWith('TEST-'));
        saveInvoicesToFile();
      } catch (e) {
        alert('Erreur: ' + e.message);
      }
    }

    // Ajouter cette fonction dans finance.html ou dans invoice-manager.js
    function diagnoseAndRepairInvoiceSystem() {
      console.log('=== DIAGNOSTIC ET R√âPARATION DU SYST√àME DE FACTURES ===');
      
      try {
        // 1. V√©rifier le fichier
        const fs = require('fs');
        const invoicesPath = window.invoicesPath;
        
        console.log('Chemin du fichier:', invoicesPath);
        
        if (fs.existsSync(invoicesPath)) {
          console.log('Fichier trouv√©');
          
          // Lire le contenu
          const content = fs.readFileSync(invoicesPath, 'utf8');
          console.log(`Taille du contenu: ${content.length} caract√®res`);
          
          // Parser le JSON
          try {
            const data = JSON.parse(content);
            console.log(`Le fichier contient ${data.length} factures`);
            
            // 2. Comparer avec les factures en m√©moire
            console.log(`Factures en m√©moire: ${window.invoices ? window.invoices.length : 'undefined'}`);
            
            // 3. Forcer le chargement depuis le fichier
            window.invoices = data;
            
            // 4. Mettre √† jour l'interface
            if (typeof updateInvoicesList === 'function') {
              updateInvoicesList();
            }
            
            alert(`R√©paration termin√©e! ${data.length} factures charg√©es.`);
          } catch (e) {
            console.error('Erreur de parsing:', e);
            alert('Erreur de parsing JSON: ' + e.message);
          }
        } else {
          alert('Fichier non trouv√©: ' + invoicesPath);
        }
      } catch (e) {
        alert('Erreur: ' + e.message);
      }
    }
    </script>
</body>
</html>